# [Web Application Security Testing](../README.md) -> __Weak Session ID. Session Fixation. CSRF__

- [Web Application Security Testing -\> __Weak Session ID. Session Fixation. CSRF__](#web-application-security-testing---weak-session-id-session-fixation-csrf)
  - [__Weak Session ID__](#weak-session-id)
  - [__Session Fixation__](#session-fixation)
  - [__CSRF__](#csrf)
    - [:warning: __WARNING:__ *There is a bug in this task!!!* :warning:](#warning-warning-there-is-a-bug-in-this-task-warning)
      - [*Possible ways to fix the error*](#possible-ways-to-fix-the-error)

## __Weak Session ID__

![Weak Session ID](./res/img/TaskWeakSessionID.png)

Solution

1. Launch a terminal (*`[Ctrl]`+`[Alt]`+`[T]`*)

2. Type `curl -v http://178.172.195.18:11177/weak_sessionID/`.

   > __NOTE:__ `-v` - to display additional information (*headers, cookies, etc.*)

3. Let's see more information to find cookies.

   > __NOTE:__
   >
   > Here we found the `user=SXRJc1RoZVNlc3Npb25PZkFuVXN1YWxVc2Vy` cookie encoded in Base64 format.
   >
   > Let's see what data is encrypted.

4. Select `SXRJc1RoZVNlc3Npb25PZkFuVXN1YWxVc2Vy`

5. Right-click the selected ad and select "*Copy Selected*."

   ![Weak Session ID](./res/img/wsid_001.png)

6. Open your preferred web browser.

7. Enter `base64 decode online`.

8. Open the first link (*e.g.: <https://www.base64encode.org/>*)

   ![Weak Session ID](./res/img/wsid_002.png)

9. Right-click the "__Decode from Base64__" input and paste the copied value.

10. Press the `[< DECODE >]` button.

11. The `ItIsTheSessionOfAnUsualUser` value has been decoded.

    ![Weak Session ID](./res/img/wsid_003.png)

    > __Try to guess:__
    >
    > If we change `UsualUser` part to `Admin` and code it, it will affect the application...

12. Click the `[Encode]` button on the top of page.

13. Insert `ItIsTheSessionOfAnUsualUser` into the "__Encode to Base64__" input.

14. Change `ItIsTheSessionOfAnUsualUser` to `ItIsTheSessionOfAnAdmin`.

15. Press the `[> CODING <]` button.

16. Select `SXRJc1RoZVNlc3Npb25PZkFuQWRtaW4=` and copy the new encoded value.

    ![Weak Session ID](./res/img/wsid_004.png)

17. Go back to the terminal and type `curl --cookie "user=SXRJc1RoZVNlc3Npb25PZkFuQWRtaW4=" -v http://178.172.195.18:11177/weak_sessionID/`

18. Obviously this affected the behavior of the application and we received a "*Flag*".

    ![Weak Session ID](./res/img/wsid_005.png)

## __Session Fixation__

Task

1. Your target is admin!
2. Try to attack him via any messenger and get the access to admin account.
3. You will find the flag there.

![Session Fixation](./res/img/TaskSessionFixation.png)

Solution

1. To use a session fixation attack, we need to verify that the basic requirements are met.

   1. Session IDs must be persistent and can't be changed by privilege escalation.
   2. The web application must support operations with the provided sessions and not modify them.

2. Before we begin, let's clear all cookies (*if any*) from the target web application.

   - Press the `[F12]` button (*to open the developer toolbar*).
   - Go to the "*Storage*" tab.
   - Expand the "*Cookies*" menu.
   - Right-click on them and select "__Delete All__".

   ![Session fixation](./res/img/sf_001.png)

3. Now we need to enter any username and password (*for example: `Violet`/`vpass`*).

   > __NOTE:__
   >
   > If the user does not exist, a new account will be created.
   >
   > If the message "*You have entered an incorrect username or password*" appears, the user exists.

4. After logging in, we need to check what are the cookies were installed.

   - Press the `[F12]` button.
   - Go to the “*Storage*” tab.
   - Expand the “*Cookies*” menu.

   ![Session fixation](./res/img/sf_002.png)

5. As we can see, cookies were not set. As a result, all necessary requirements are met.

   > __IMPORTANT NOTE:__
   >
   > If we look at the URL, the construct `?session=2222d8774ceed0e4144f419505fc40e1cc51b844` should set that session ID, but nothing happened. I don't know why, but this may make it impossible to carry out this attack. I'll try to implement this, but I'm not sure if it's possible.
   >
   > According to [RFC 6265](https://datatracker.ietf.org/doc/html/rfc6265#page-8), cookies can be set via the Set-Cookie header, using JavaScript, or received from a server application, they are also can be installed manually in a real browser. A GET request can only create a temporary variable whose lifecycle is limited by page reloads.
   >
   > ![Session fixation](./res/img/sf_003_extra.png)
   >
   > ![Session fixation](./res/img/sf_004_extra.png)
   >
   > ![Session fixation](./res/img/sf_005_extra.png)

6. We see the message “*Use your session to attack: 2222d8774ceed0e4144f419505fc40e1cc51b844*”.

   ![Session fixation](./res/img/sf_006.png)

   > __IMPORTANT NOTE:__
   >
   > After re-login, the __token was changed__!
   >
   > When we have prefered and esnt the link for hacking, we __must remain in the system__ until we receive the "*Flag*".
   >
   > ![Session fixation](./res/img/sf_007_extra.png)

7. To carry out the attack, we need to prepare a link and send it to the admin.

8. Select everything in the address bar. Right-click on the selection and select "__Copy__".

   ![Session fixation](./res/img/sf_008.png)

   > __NOTE:__ It already contains all the necessary parameters.

9. In fact, this line is already a link, but to hide the context, it is advisable to place it in the `href=""` attribute of the `<a>` tag and find a suitable messenger that will allow you to display only the link title, hiding the HTML code.

   You should end up with something like this

   ```html
   <a href="http://178.172.195.18:11177/session_fixation/index.php?session=2222d8774ceed0e4144f419505fc40e1cc51b844">Problem Report</a>
   ```

10. Open the messenger and, using social engineering, try to distract the administrator’s attention so that he clicks on our link. Additionally, you can find out the time when he will do this.

    ![Session fixation](./res/img/sf_009.png)

11. Refresh the page periodically to check for expected privilege increases. If an administrator answers you and asks a question about the missing report, you can be sure that he will use our link.

12. Refresh the page and get the "*Flag*".

## __CSRF__

Task

1. Your target is admin!
2. Try to attack him via any messenger and get the access to admin account.
3. You will find the flag there.
4. [This page](http://178.172.195.18:11188) can help you during preparation and attack phases.

   ![Upload page](./res/img/TaskCSRFUploadPage.png)

![CSRF](./res/img/TaskCSRF.png)

---

### :warning: __WARNING:__ *There is a bug in this task!!!* :warning:

When I try to login as a __`test`__ user with the password __`test`__, I get the error "*You have entered an incorrect username or password*".

![Bug](./res/img/csrf_bug_001.png)

The same situation happens again when I try to login as user __`admin`__ with password __`admin`__.

![Bug](./res/img/csrf_bug_002.png)

Of course, the system checks whether the user exists in some storage. The message that appears indicates that users *`admin`* or *`test`* exist. On the other hand, if no users exist, the system must __create a new one__.

Let's __analyze what happens__ when we use the csrf attack to solve this problem.

We should prepare an HTML page on which we will place the "*newPass*" form, where we will specify the password we know. Then send it to the administrator. When the administrator opens the page, his password should be replaced with ours.

__Attention!__ If the administrator user has recently been attacked, perhaps his password has been changed to some simple one and now we can find it out by brute force. Let's check it out!

![Bug](./res/img/csrf_bug_003.png)

As we can see, the administrator password was found. Try logging in with these credentials.

![Bug](./res/img/csrf_bug_004.png)

#### *Possible ways to fix the error*

There are many ways to fix the error. It is necessary to reset the administrator password periodically.

For example (*implementation dependent*):

1. Use a system script (*for file databases*)
2. Use stored procedures (*for a database management system*)
3. Change the business logic of the application after receiving the flag.

and so on.

---

Solution

1. We need to login as administrator, but we don't know the administrator password.

   ![CSRF](./res/img/csrf_001.png)

2. First of all we have to enter any username and password (*e.g.: `test`/`test`*). If the user does not exist a new account will be created.

   > __NOTE:__
   >
   > If the message "*You have entered an incorrect username or password*" appears, the user exists.
   >
   > I came across this and it helped me find a [bug](#warning-warning-there-is-a-bug-in-this-task-warning). I had to use a different user to login

   ![CSRF](./res/img/csrf_002.png)

3. Right-click anywhere on the page and select "*View Page Source*"

   ![CSRF](./res/img/csrf_003.png)

4. Some of the code is outside the viewport. To make analysis easier, press `[Ctrl]`+`[a]` to select it and right-click to "__*Copy*__" the selection.

   ![CSRF](./res/img/csrf_004.png)

5. Open your preferred text editor to create the exploit html page.

   ![CSRF](./res/img/csrf_005.png)

6. Press `[i]` then [Shift]+[Ctrl]+[v] to paste the code.

   ![CSRF](./res/img/csrf_006.png)

7. Refactor and analyze the source code.

   ![CSRF](./res/img/csrf_007.png)

8. Cleaning up unnecessary code, adding automation scripts and distracting image.

   ![CSRF](./res/img/csrf_008.png)

9. Press `[Esc]` (*to activate command mode*), then enter `[Shift]`+`[;]`, `[w]` (*write*), `[q]` (*exit*) and `[Enter]`.

10. All necessary well done. Let's check now it is work.

11. First, we need to create a new victim user. So, username "__`victim`__" password "__`lucky`__".

    ![CSRF](./res/img/csrf_009.png)

12. Enter *username:* "__`victim`__", *password:* "__`lucky`__" and click the `[Submit]` button.

    ![CSRF](./res/img/csrf_010.png)

13. To carry out an attack, just open the prepared page in the browser.
14. Open the file location, right-click it (*here __`drawing_cats.html`__*) and select "__*Open With...*__".

    ![CSRF](./res/img/csrf_011.png)

15. The page loaded and let's go check the result.

    ![CSRF](./res/img/csrf_012.png)

16. Log out of the victim's account.

    ![CSRF](./res/img/csrf_013.png)

17. Try logging in again using "__`victim`__" and "__`lucky`__".

    ![CSRF](./res/img/csrf_014.png)

18. We received a message stating that the username or password is incorrect.

    ![CSRF](./res/img/csrf_015.png)

19. Try logging in with the password from the html file (*`vpass`*)

    ![CSRF](./res/img/csrf_016.png)

20. Well done!

    ![CSRF](./res/img/csrf_017.png)

21. Submit the __`drawing_cats.html`__ file to the admin.

    ![CSRF](./res/img/csrf_018.png)

    ![CSRF](./res/img/csrf_019.png)

    > __NOTE:__ The file was renamed and saved as __`1765868449.html`__.

22. After a while, try to log in as "__`admin`__" with the password from the *`Drawing_cats.html`* file.

    ![CSRF](./res/img/csrf_020.png)
